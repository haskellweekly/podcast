version: v1.0
name: Build pipeline
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: semaphoreci/haskell:8.6.5
blocks:
  - name: Build block
    task:
      env_vars:
        - { name: CABAL_DIR, value: .cabal }
        - { name: ROOT_URL, value: https://haskellweekly.news/podcast/ }
      jobs:
        - name: Build job
          commands:
            - checkout
            - cabal v2-update
            - cabal v2-freeze
            - cabal restore "cabal-$( checksum cabal.project.freeze )"
            - cabal restore "dist-$( checksum podcast.cabal )"
            - cabal v2-build
            - cabal v2-run
            - cache store "cabal-$( checksum cabal.project.freeze )" .cabal
            - cabal store "dist-$( checksum podcast.cabal )" dist-newstyle
            - cache store "output-$SEMAPHORE_GIT_SHA" output
promotions:
  - name: Deploy promotion
    pipeline_file: deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
