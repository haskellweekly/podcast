version: v1.0
name: Build pipeline
agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: semaphoreci/haskell:8.6.5
blocks:
  - name: Build block
    task:
      jobs:
        - name: Build job
          commands:
            - checkout
            - cache restore "stack-root-$( checksum stack.yaml )"
            - cache restore "stack-work-$( checksum package.yaml )"
            - stack build
            - env ROOT_URL=https://haskellweekly.news/podcast/ stack exec podcast
            - cache store "stack-root-$( checksum stack.yaml )" /root/.stack
            - cache store "stack-work-$( checksum package.yaml )" .stack-work
            - cache store "output-$SEMAPHORE_GIT_SHA" output
promotions:
  - name: Deploy promotion
    pipeline_file: deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
