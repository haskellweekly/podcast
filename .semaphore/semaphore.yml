version: v1.0
name: Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Block
    task:
      jobs:
        - name: Job
          commands:
            - checkout
            - docker run --rm --volume "$(pwd):/root/podcast" --workdir /root/podcast alpine:3.9.2 sh -c 'apk add --no-cache cabal ghc musl-dev wget && cabal new-update && cabal new-build && cabal new-exec podcast'
            - sudo chown -R "$USER" output
            - cache store "output-$SEMAPHORE_GIT_SHA"
promotions:
  - name: Promotion
    pipeline_file: promotion.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
